{% extends "base.html" %}

{% block title %}Planes - Sistema de Control de Acceso{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-clipboard-list"></i> Gestión de Planes</h1>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#planModal">
        <i class="fas fa-plus"></i> Agregar Plan
    </button>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped" id="plansTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Ingresos Mensuales</th>
                        <th>Fecha Creación</th>
                        <th>Última Actualización</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Plan Modal -->
<div class="modal fade" id="planModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Agregar/Editar Plan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="planForm">
                <div class="modal-body">
                    <input type="hidden" id="planId">
                    <div class="mb-3">
                        <label for="planName" class="form-label">Nombre del Plan</label>
                        <input type="text" class="form-control" id="planName" required>
                    </div>
                    <div class="mb-3">
                        <label for="planEntries" class="form-label">Ingresos Mensuales</label>
                        <input type="number" class="form-control" id="planEntries" min="1" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let plans = [];

async function loadPlans() {
    try {
        const token = getCookieValue('access_token');
        if (!token) {
            window.location.href = '/admin/login';
            return;
        }
        
        const response = await axios.get('/api/plans/', {
            headers: { 
                'Authorization': token,
                'Content-Type': 'application/json'
            }
        });
        
        plans = response.data;
        renderPlansTable();
    } catch (error) {
        console.error('Error loading plans:', error);
        if (error.response && error.response.status === 401) {
            window.location.href = '/admin/login';
        } else {
            alert('Error al cargar planes: ' + (error.response?.data?.detail || error.message));
        }
    }
}

function renderPlansTable() {
    const tbody = document.querySelector('#plansTable tbody');
    tbody.innerHTML = plans.map(plan => `
        <tr>
            <td>${plan.id}</td>
            <td>${plan.name}</td>
            <td>${plan.monthly_entries}</td>
            <td>${new Date(plan.created_at).toLocaleDateString()}</td>
            <td>${new Date(plan.updated_at).toLocaleDateString()}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editPlan(${plan.id})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deletePlan(${plan.id})">
                    <i class="fas fa-trash"></i>
                </button>
                <a href="/reports/plan/${plan.id}" class="btn btn-sm btn-outline-info">
                    <i class="fas fa-chart-bar"></i>
                </a>
            </td>
        </tr>
    `).join('');
}

function editPlan(id) {
    const plan = plans.find(p => p.id === id);
    if (plan) {
        document.getElementById('planId').value = plan.id;
        document.getElementById('planName').value = plan.name;
        document.getElementById('planEntries').value = plan.monthly_entries;
        document.querySelector('#planModal .modal-title').textContent = 'Editar Plan';
        new bootstrap.Modal(document.getElementById('planModal')).show();
    }
}

async function deletePlan(id) {
    if (confirm('¿Estás seguro de que quieres eliminar este plan?')) {
        try {
            const token = getCookieValue('access_token');
            if (!token) {
                window.location.href = '/admin/login';
                return;
            }
            
            await axios.delete(`/api/plans/${id}`, {
                headers: { 
                    'Authorization': token,
                    'Content-Type': 'application/json'
                }
            });
            
            alert('Plan eliminado exitosamente');
            loadPlans();
        } catch (error) {
            console.error('Error deleting plan:', error);
            if (error.response && error.response.status === 401) {
                window.location.href = '/admin/login';
            } else {
                alert('Error al eliminar plan: ' + (error.response?.data?.detail || error.message));
            }
        }
    }
}

document.getElementById('planForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const id = document.getElementById('planId').value;
    const data = {
        name: document.getElementById('planName').value,
        monthly_entries: parseInt(document.getElementById('planEntries').value)
    };
    
    try {
        const token = getCookieValue('access_token');
        if (!token) {
            window.location.href = '/admin/login';
            return;
        }
        
        const headers = {
            'Authorization': token,
            'Content-Type': 'application/json'
        };
        
        if (id) {
            await axios.put(`/api/plans/${id}`, data, { headers });
        } else {
            await axios.post('/api/plans/', data, { headers });
        }
        
        bootstrap.Modal.getInstance(document.getElementById('planModal')).hide();
        this.reset();
        document.getElementById('planId').value = '';
        document.querySelector('#planModal .modal-title').textContent = 'Agregar Plan';
        
        alert('Plan guardado exitosamente');
        loadPlans();
    } catch (error) {
        console.error('Error saving plan:', error);
        if (error.response && error.response.status === 401) {
            window.location.href = '/admin/login';
        } else {
            alert('Error al guardar plan: ' + (error.response?.data?.detail || error.message));
        }
    }
});

// Reset form when modal is hidden
document.getElementById('planModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('planForm').reset();
    document.getElementById('planId').value = '';
    document.querySelector('#planModal .modal-title').textContent = 'Agregar Plan';
});

function getCookieValue(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return '';
}

document.addEventListener('DOMContentLoaded', loadPlans);
</script>
{% endblock %}
